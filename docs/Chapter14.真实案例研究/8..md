Discord 如何存储数万亿条消息下面的图表显示了 Discord 消息存储的演变：![](../images/discord-store-messages.jpg)MongoDB ➡️ Cassandra ➡️ ScyllaDB2015 年，Discord 的第一个版本是建立在单个 MongoDB 副本之上的。到了 2015 年 11 月左右，MongoDB 存储了 1 亿条消息，RAM 无法再容纳数据和索引。延迟变得不可预测。消息存储需要迁移到另一个数据库。选择了 Cassandra。2017 年，Discord 有 12 个 Cassandra 节点，存储了数十亿条消息。2022 年初，它有 177 个节点，传输了数万亿条消息。此时，延迟是不可预测的，维护操作变得太昂贵而无法运行。问题存在几个原因：Cassandra 使用 LSM 树作为内部数据结构。 读取比写入更昂贵。 在具有数百用户的服务器上可能会有许多并发读取，导致热点。维护集群，如压缩 SSTables，会影响性能。垃圾收集暂停会导致显著的延迟峰值ScyllaDB 是用 C++编写的与 Cassandra 兼容的数据库。Discord 重新设计了其架构，拥有一个单体 API，一个用 Rust 编写的数据服务，以及基于 ScyllaDB 的存储。ScyllaDB 中的 p99 读取延迟为 15 毫秒，而 Cassandra 中为 40-125 毫秒。p99 写入延迟为 5 毫秒，而 Cassandra 中为 5-70 毫秒。